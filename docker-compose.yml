# Usage:
#   docker compose up --build              # starts everything

x-app: &app
  build: .
  environment:
    DATABASE_URL: postgresql+psycopg2://wikiapp:wikiapp@postgres:5432/museums
    ARTIFACTS_DIR: /app/artifacts
  volumes: [artifacts:/app/artifacts]

services:
  postgres:
    image: postgres:16-alpine
    environment: { POSTGRES_USER: wikiapp, POSTGRES_PASSWORD: wikiapp, POSTGRES_DB: museums }
    ports: ["5432:5432"]
    volumes: [pgdata:/var/lib/postgresql/data]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U wikiapp -d museums"]
      interval: 3s
      retries: 10

  pipeline:
    <<: *app
    depends_on: { postgres: { condition: service_healthy } }
    command: ["run-all", "--verbose"]

  api:
    <<: *app
    ports: ["8000:8000"]
    depends_on: { pipeline: { condition: service_completed_successfully } }
    entrypoint: ["uvicorn", "wikiapp.api:app", "--host", "0.0.0.0", "--port", "8000"]

  notebook:
    <<: *app
    ports: ["8888:8888"]
    depends_on: { pipeline: { condition: service_completed_successfully } }
    entrypoint: ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser",
                  "--allow-root", "--ServerApp.token=''", "--notebook-dir=/app/notebooks"]

volumes:
  pgdata:
  artifacts:
